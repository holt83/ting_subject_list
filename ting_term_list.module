<?php

/**
 * @file
 *
 * Module file for the Ting subject list module.
 */

/* Constants */
define('TING_TERM_LIST_PATH', drupal_get_path('module', 'ting_term_list'));


/**
 * Implements hook_ctools_plugin_directory().
 */
function ting_term_list_ctools_plugin_directory($owner, $plugin_type) {
	if ($owner == 'ctools' && !empty($plugin_type)) {
		return "plugins/$plugin_type";
	}
}

/**
 * Implements hook_theme().
 */
function ting_term_list_theme() {
	$common = array(
		'path' => TING_TERM_LIST_PATH . '/theme',
		'file' => 'theme.inc', 
	);
	return array(
		'ting_term_list' => array(
			'variables' => array(
				'terms' => array(),
				'column_count' => 3,
			),
			'template' => 'ting-term-list',
		) + $common,
		'ting_term_list_column' => array(
			'variables' => array(
				'terms' => array(),
				'column_title' => NULL,
			),
			'template' => 'ting-term-list-column',
		) + $common,
		'ting_term_list_term' => array(
			'variables' => array(
				'term_name' => NULL,
				'term_count' => 0,
			),
			'template' => 'ting-term-list-term',
		) + $common,
	);
}

/**
 * Fetch Ting material terms from the data well, using the facet search option 
 * on the OpenSearch webservice. 
 * Returns an array keyed by term-names and their associated material count.
 *
 * @param $query
 *   A cql query string specifying a category of terms (e.g. 'bog', 'musik').
 * @param $num_resullt
 *   The max number of terms to return.
 */
function ting_term_list_get_terms($query, $num_results) {
	require_once drupal_get_path('module', 'ting') . '/ting.client.inc';

	$request = ting_get_request_factory()->getSearchRequest();
	$request->setQuery($query);
	if ($agency = variable_get('ting_agency', FALSE)) {
		$request->setAgency($agency);
	}
	$profile = variable_get('ting_search_profile', '');
	if (!empty($profile) && method_exists($request, 'setProfile')) {
	  $request->setProfile($profile);
	}
	// Use facet.subject to get terms
	$request->setFacets(array('facet.subject'));
	// Set the number of subjects to return
	$request->setNumFacets($num_results);

	// Get the terms from search result object
	$search_result = ting_execute($request);
	$terms = array();
	if (isset($search_result->facets)) {
		$terms = $search_result->facets['facet.subject']->terms;
	}
	return $terms;
}

/**
 * Returns a well structured settings array from the field values in the node.
 */
function ting_term_list_get_term_list_settings($node) {
	$fields = array(
		'category' => 'field_term_list_term_cat',
		'count' => 'field_term_list_term_count',
	);
	$settings = array();
	foreach ($fields as $key => $field) {
		if (!empty($node->{$field})) {
			$value = field_get_items('node', $node, $field);
			$value = array_shift(array_values($value));
			$value = $value['value'];
			$settings[$key] = $value;
		}
	}
	return $settings;
}